<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Qual é a tatuagem certa pra você?</title>
<style>
  :root{
    --bg:#f7f7f8; --card:#fff; --ink:#111; --muted:#666; --line:#e6e6e8;
    --radius:16px;
    --accent:#7A8B55; /* Pantone 17-0336 TCX Moss Green (aprox.) */
    --accent-ink:#fff;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,sans-serif;background:var(--bg);color:var(--ink)}
  .wrap{max-width:860px;margin:0 auto;padding:24px}
  header h1{font-size:clamp(22px,2.8vw,34px);margin:10px 0 4px}
  header p{color:var(--muted);margin:0 0 12px;font-size:clamp(14px,2vw,18px)}
  .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:0 6px 16px rgba(0,0,0,.04);padding:20px}
  .row{display:grid;grid-template-columns:1fr;gap:12px}
  @media (min-width:720px){.row2{grid-template-columns:1fr 1fr}}
  .title{font-size:20px;margin:0 0 6px}
  .muted{color:var(--muted);font-size:13px}
  .btn{appearance:none;border:1px solid var(--line);background:#fff;color:var(--ink);border-radius:12px;padding:12px 14px;text-align:left;cursor:pointer;transition:.2s;word-break:break-word}
  .btn:hover{border-color:#111}
  .btn.primary{text-align:center;background:var(--accent);color:var(--accent-ink);border-color:var(--accent)}
  .btn.block{width:100%}
  .btn.sel{border-color:var(--accent)}
  .btn[disabled]{opacity:.6;cursor:not-allowed}
  .btn:focus-visible{outline:2px solid var(--accent);outline-offset:2px}
  .actions{display:flex;justify-content:space-between;gap:10px;margin-top:10px}
  .prog{height:8px;background:#e9e9ec;border-radius:999px;overflow:hidden;margin:10px 0 16px}
  .prog>i{display:block;height:100%;background:var(--accent);width:0}
  input[type="text"]{width:100%;padding:12px;border:1px solid #d9d9df;border-radius:12px}
  .kicker{font-size:12px;text-transform:uppercase;color:var(--muted);margin-top:14px}
  .footer{margin:24px 0 10px;text-align:center;color:#888;font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Qual é a tatuagem certa pra você?</h1>
    <p>Responda algumas perguntas rápidas e descubra o desenho, o tamanho e o local perfeitos para o seu estilo.</p>
  </header>

  <div id="app"></div>

  <div class="footer">© <span id="year"></span> • Feito com carinho por Laís • Uberaba-MG</div>
</div>

<script>
(function(){
  // ===== CONFIG =====
  const HOURLY = 150;                 // R$/hora (interno)
  const FORMSPREE_ENDPOINT = "https://formspree.io/f/mvgblrjq";

  // ===== UTIL =====
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const el = (tag, attrs = {}, ...kids) => {
    const n = document.createElement(tag);
    if (tag === "button" && !("type" in attrs)) n.setAttribute("type","button");
    const boolAttrs = new Set(["disabled","checked","selected","readonly","multiple","required","autofocus","hidden"]);
    Object.entries(attrs).forEach(([k,v])=>{
      if (k==="class") n.className = v;
      else if (k==="html") n.innerHTML = v;
      else if (k.startsWith("on")) n.addEventListener(k.slice(2).toLowerCase(), v);
      else if (boolAttrs.has(k)) { if (v) n.setAttribute(k,""); else n.removeAttribute(k); }
      else if (v !== false && v != null) n.setAttribute(k, String(v));
    });
    kids.forEach(k=>{ if(k==null) return; n.appendChild(typeof k==="string"?document.createTextNode(k):k); });
    return n;
  };

  // ===== PERGUNTAS =====
  const Q = [
    { id:"nome", t:"Qual é o seu nome?", type:"text", req:false, ph:"Digite seu nome" },

    { id:"experiencia", t:"Você já tem tatuagens ou seria a sua primeira?", type:"single",
      options:[
        {label:"Será minha primeira — ainda tenho algumas dúvidas e receios.", tags:{first:true}},
        {label:"Já tenho — quero complementar ou fazer algo novo.",           tags:{first:false}},
      ]},

    { id:"receio", t:"Qual é o seu maior receio em relação à tatuagem?", type:"single",
      options:[
        {label:"Arrependimento",tags:{fear:"arrependimento"}},
        {label:"Julgamento",    tags:{fear:"julgamento"}},
        {label:"Dor",           tags:{fear:"dor"}},
        {label:"Custo",         tags:{fear:"custo"}},
        {label:"Nenhum",        tags:{fear:"nenhum"}},
      ]},

    { id:"perfil", t:"Qual dessas descrições mais combina com você?", type:"single",
      options:[
        {label:"Autêntico(a) / Criativo(a) — tatuagem como arte no corpo.", tags:{persona:"artistico"}},
        {label:"Romântico(a) / Emocional — valorizo sentimentos e memórias.", tags:{persona:"romantico"}},
        {label:"Rebelde / Questionador(a) — força e atitude.", tags:{persona:"rebelde"}},
        {label:"Espiritual / Místico(a) — conexão e proteção.", tags:{persona:"mistico"}},
        {label:"Social / Estético(a) — moda, cultura pop, identidade de grupo.", tags:{persona:"social"}},
      ]},

    { id:"comunicar", t:"O que você mais quer comunicar com essa tatuagem?", type:"single",
      options:[
        {label:"Poder me expressar",           tags:{motive:"expressao"}},
        {label:"Homenagem",                    tags:{motive:"homenagem"}},
        {label:"Posicionamento e confronto",   tags:{motive:"atitude"}},
        {label:"Fé/Propósito",                 tags:{motive:"fe"}},
        {label:"Estética",                     tags:{motive:"estetica"}},
      ]},

    { id:"estilo", t:"Qual estilo mais combina com você? (calibra linguagem)", type:"single",
      options:[
        {label:"Fine Line — traços finos e minimalistas", tags:{prefStyle:"fineline"}},
        {label:"Blackwork — preto intenso e contrastes",  tags:{prefStyle:"blackwork"}},
        {label:"Realismo",                                tags:{prefStyle:"realismo"}},
      ]},

    { id:"universo", t:"Qual universo estético mais combina com você?", type:"single",
      options:[
        {label:"Clássico: estética inspirada na arte greco-romana e renascentista", tags:{universe:"classico"}},
        {label:"Pop-Geek: universo de cultura pop (HQs, games, anime)",             tags:{universe:"pop"}},
        {label:"Natureza: foco em flora, fauna e paisagens",                        tags:{universe:"natureza"}},
        {label:"Mitologia: deuses, criaturas e símbolos arquetípicos",              tags:{universe:"mitologia"}},
        {label:"Figuras humanas e personagens",                                     tags:{universe:"retrato"}},
      ]},

    { id:"visibilidade", t:"Você quer que sua tatuagem apareça no dia a dia?", type:"single",
      options:[
        {label:"Discreta",    tags:{vis:"baixa"}},
        {label:"Moderada",    tags:{vis:"media"}},
        {label:"Bem visível", tags:{vis:"alta"}},
      ]},

    { id:"trabalho", t:"Como é o seu ambiente de trabalho em relação a tatuagens?", type:"single",
      options:[
        {label:"Formal",  tags:{work:"formal"}},
        {label:"Híbrido", tags:{work:"hibrido"}},
        {label:"Liberal", tags:{work:"liberal"}},
      ]},

    { id:"volubilidade", t:"Você enjoa fácil de coisas visuais?", type:"single",
      options:[
        {label:"Sim — prefiro não ver o tempo todo", tags:{volu:"alta"}},
        {label:"Mais ou menos",                      tags:{volu:"media"}},
        {label:"Não",                                tags:{volu:"baixa"}},
      ]},

    { id:"dor", t:"Como você lida com dor durante procedimentos?", type:"single",
      options:[
        {label:"Baixa tolerância", tags:{pain:"baixa"}},
        {label:"Média",            tags:{pain:"media"}},
        {label:"Alta tolerância",  tags:{pain:"alta"}},
      ]},

    { id:"tempoSessao", t:"Quanto tempo você topa ficar em uma sessão?", type:"single",
      options:[
        {label:"1–2h",               tags:{session:"curta"}},
        {label:"3–4h",               tags:{session:"media"}},
        {label:"5–6h",               tags:{session:"longa"}},
        {label:"Mais de uma sessão", tags:{session:"multi"}},
      ]},

    { id:"diaSemana", t:"Dias preferidos para tatuar", type:"single",
      options:[
        {label:"Dias úteis",       tags:{day:"uteis"}},
        {label:"Finais de semana", tags:{day:"fds"}},
        {label:"Qualquer",         tags:{day:"qualquer"}},
      ]},

    { id:"periodoDia", t:"Período do dia preferido", type:"single",
      options:[
        {label:"Manhã",       tags:{period:"manha"}},
        {label:"Tarde",       tags:{period:"tarde"}},
        {label:"Noite",       tags:{period:"noite"}},
        {label:"Indiferente", tags:{period:"indiferente"}},
      ]},

    { id:"investimento", t:"Qual faixa de investimento você considera? (interno, não exibimos valores)", type:"single",
      options:[
        {label:"R$ 150 – R$ 600",     tags:{budgetMin:150,budgetMax:600}},
        {label:"R$ 600 – R$ 1.200",   tags:{budgetMin:600,budgetMax:1200}},
        {label:"R$ 1.200 – R$ 2.500", tags:{budgetMin:1200,budgetMax:2500}},
        {label:"A partir de R$ 2.500",tags:{budgetMin:2500,budgetMax:999999}},
      ]},

    { id:"homenagem", t:"Sua tatuagem seria uma homenagem?", type:"single",
      options:[
        {label:"Pessoa querida",      tags:{tribute:"pessoa"}},
        {label:"Pet",                 tags:{tribute:"pet"}},
        {label:"Fé/Espiritualidade",  tags:{tribute:"fe"}},
        {label:"Talvez",              tags:{tribute:"talvez"}},
        {label:"Não",                 tags:{tribute:"nao"}},
      ]},

    { id:"presenca", t:"Quando alguém olhar para a sua tatuagem, que reação você quer provocar?", type:"single",
      options:[
        {label:"Discreta (quase imperceptível / elegante)",         tags:{presence:"discreta"}},
        {label:"Conversável (gera curiosidade e diálogo)",          tags:{presence:"equilibrada"}},
        {label:"Protagonista (marca presença forte / manifesto)",   tags:{presence:"impactante"}},
      ]},

    { id:"areas", t:"Áreas preferidas (opcional)", type:"multi",
      options:[
        {label:"Braço (antebraço/bíceps/ombro)", tags:{area:"braco"}},
        {label:"Perna (coxa/panturrilha)",       tags:{area:"perna"}},
        {label:"Costas (alta ou média)",         tags:{area:"costas"}},
        {label:"Tórax/Peito",                    tags:{area:"peito"}},
        {label:"Costela/Lateral",                tags:{area:"costela"}},
        {label:"Mão/Punho",                      tags:{area:"mao"}},
        {label:"Pescoço",                        tags:{area:"pescoco"}},
        {label:"Sem preferência",                tags:{area:"nenhuma"}},
      ]},

    { id:"astrologia", t:"Inspiração astrológica? (opcional)", type:"single",
      options:[
        {label:"Não",   tags:{astro:null}},
        {label:"Elemento água (câncer, escorpião, peixes): ondas, lua, água-viva, concha", tags:{astro:"agua"}},
        {label:"Elemento fogo (áries, leão, sagitário): chamas, sol, fênix, vulcão",       tags:{astro:"fogo"}},
        {label:"Elemento terra (touro, virgem, capricórnio): montanhas, árvore, cristal, espiga de trigo", tags:{astro:"terra"}},
        {label:"Elemento ar (gêmeos, libra, aquário): nuvens, pássaros, dente-de-leão, linhas de vento",   tags:{astro:"ar"}},
      ]},

    { id:"valores", t:"Quais símbolos você gostaria de acrescentar à sua tatuagem?", type:"single",
      options:[
        {label:"Sem símbolos",             tags:{values:null}},
        {label:"Arabescos e filigranas",   tags:{values:"autenticidade"}},
        {label:"Desenhos geométricos",     tags:{values:"natureza"}},
        {label:"Elementos arquitetônicos", tags:{values:"fe"}},
      ]},

    { id:"musica", t:"Música/cultura influencia? (opcional)", type:"single",
      options:[
        {label:"Não muito", tags:{music:null}},
        {label:"Rock",      tags:{music:"rock"}},
        {label:"MPB/Indie", tags:{music:"mpb"}},
        {label:"Pop",       tags:{music:"pop"}},
        {label:"Rap/Trap",  tags:{music:"rap"}},
        {label:"Clássica",  tags:{music:"classica"}},
      ]},
  ];

  // ===== REGRAS (temas) =====
  const THEME_BY_PERSONA = {
    romantico:["Celebra vínculos afetivos com símbolos de amor, florais e frases delicadas"],
    rebelde:["Feita para desafiar padrões como caveira, chamas, pantera"],
    mistico:["Traduz a espiritualidade, intuição e proteção em símbolos esotéricos, fases da lua, sol, constelações"],
    artistico:["Autoral: sua ideia transformada em uma composição única"],
    social:["Para visibilizar causas, identidades e pertencimentos como frases curtas, símbolos e grafismos"],
  };
  const CULTURE_MOD = {
    classico:["Proporção e simetria com dramatismo escultórico, inspirada na arte antiga/renascentista, enfatizando luz e sombra e ornamentos históricos"],
    pop:["referência cinematográfica sutil","ícone pop em realismo"],
    natureza:["Retrata plantas, flores, folhas e ramos com ênfase em formas orgânicas e detalhes naturais (nervuras, pétalas, texturas)"],
    mitologia:["Representa deuses, heróis, criaturas e símbolos de mitos"],
    retrato:["Figura humana: representação de silhuetas, corpo em movimento, mãos"],
  };
  const PLACEMENTS = { alta:["antebraço externo","panturrilha","antebraço interno"], media:["bíceps","coxa","ombro"], baixa:["costela","tórax/peito","alta das costas"] };
  const LESS_SEEN=["costela","alta das costas","lateral de coxa"];
  const LOW_PAIN=["antebraço","coxa","panturrilha","ombro"];
  const SIZE_CM = { pequeno:"6–9 cm", medio:"12–18 cm", grande:"20–30 cm", projeto:"área maior em várias sessões (40+ cm no total por área)" };

  // ===== KB (tema coeso) =====
  const KB = {
    astro: {
      fogo: { resumo: "audácia e energia; luz dramática e direção marcada" },
      terra:{ resumo: "forma e técnica; texturas orgânicas e estabilidade" },
      ar:   { resumo: "leveza e movimento; composição arejada" },
      agua: { resumo: "emoção e intuição; transições suaves e fluidez" }
    },
    values: {
      autenticidade: { texto:"ornamentos em arabescos/filigranas", toque:"elegância fluida" },
      natureza:      { texto:"geometria/mandalas e padrões",       toque:"ordem e ritmo"    },
      fe:            { texto:"elementos arquitetônicos",            toque:"estrutura e propósito" }
    },
    motive: {
      expressao: "reforçar autoria e sentimento",
      homenagem: "registrar carinho e memória",
      atitude:   "afirmar posicionamento",
      fe:        "representar propósito/espiritualidade",
      estetica:  "valorizar harmonia e forma"
    },
    persona: {
      romantico: "tom afetivo e poético",
      rebelde:   "tom incisivo e desafiador",
      mistico:   "tom simbólico e protetor",
      artistico: "tom autoral e de estudo de luz",
      social:    "tom identitário e de pertencimento"
    }
  };

  // ===== Compositor de texto (tema coeso) =====
  function composeThemeText(tags){
    const parts = [];

    if (tags.tribute === "pet") {
      parts.push("Retrato realista em preto & branco do seu pet");
    } else if (tags.tribute === "pessoa") {
      parts.push("Retrato realista PB de pessoa querida");
    } else if (tags.tribute === "fe") {
      parts.push("Símbolo de fé/proteção em realismo PB");
    } else {
      const personaTxt = KB.persona[tags.persona] || "tom pessoal";
      parts.push(`Composição realista PB com ${personaTxt}`);
    }

    if (tags.motive && KB.motive[tags.motive]) {
      parts.push(`para ${KB.motive[tags.motive]}`);
    }
    if (tags.astro && KB.astro[tags.astro]) {
      parts.push(`acabamento com ${KB.astro[tags.astro].resumo}`);
    }
    if (tags.values && KB.values[tags.values]) {
      const v = KB.values[tags.values];
      parts.push(`e ${v.texto} (${v.toque})`);
    }
    if (tags.music === "rap") parts.push("toque urbano sutil");
    else if (tags.music === "rock") parts.push("texturas mais cruas");
    else if (tags.music === "mpb") parts.push("poesia orgânica");

    const frase = parts
      .filter(Boolean)
      .map((s,i)=> i===0 ? s[0].toUpperCase()+s.slice(1) : s)
      .join(", ")
      .replace(/, ([^,]+)$/, " e $1")
      + ".";

    const alts = [];
    if (tags.tribute === "pet") {
      alts.push("Close PB do olhar do pet com linhas de vento");
      alts.push("Silhueta do pet integrada a geometria minimalista");
      alts.push("Nome/data do pet em realismo suave");
    } else if (tags.tribute === "pessoa") {
      alts.push("Close PB com foco em luz & sombra");
      alts.push("Silhueta com geometria discreta");
      alts.push("Inicial/data como assinatura afetiva");
    } else {
      alts.push("Estudo de luz & sombra com foco no motivo central");
      alts.push("Composição com geometria discreta como moldura");
      alts.push("Ícone afetivo em realismo PB minimalista");
    }
    return { frase, alts: alts.slice(0,3) };
  }

  // ===== Cálculo geral =====
  const hoursFromBudget=(min,max)=>clamp(Math.round(((min+max)/2)/HOURLY),1,24);
  function sizeFromTime(h,multi=false){
    if(multi||h>=8) return {size:"projeto",label:"Projeto"};
    if(h>=4) return {size:"grande",label:"Grande"};
    if(h>=2) return {size:"medio",label:"Médio"};
    return {size:"pequeno",label:"Pequeno"};
  }
  function tone(persona){
    switch(persona){
      case"romantico":return{themeLine:"um registro de afeto e memória"};
      case"rebelde":return{themeLine:"presença e atitude"};
      case"mistico":return{themeLine:"significado e proteção"};
      case"artistico":return{themeLine:"luz e sombra em arte pessoal"};
      case"social":return{themeLine:"estilo alinhado à sua vibe"};
      default:return{themeLine:"estilo que representa quem você é"};
    }
  }

  function buildInspiration(tags){
    const parts=[];
    if(tags.astro==="agua") parts.push("linhas fluidas e temas de água (ondas, lua, conchas, água-viva)");
    if(tags.astro==="fogo") parts.push("chamas, sol, fênix e contrastes mais quentes para energia");
    if(tags.astro==="terra") parts.push("montanhas, árvores e texturas minerais (cristais, grão da pedra)");
    if(tags.astro==="ar") parts.push("composição leve com nuvens, pássaros, dente-de-leão e linhas de vento");

    if(tags.values==="autenticidade") parts.push("ornamentos em arabescos e filigranas para elegância e fluxo");
    if(tags.values==="natureza")      parts.push("geometria (mandalas, padrões e formas modulares) como base estética");
    if(tags.values==="fe")            parts.push("elementos arquitetônicos (arcos, colunas, vitrais) como símbolo de estrutura e propósito");

    if(tags.motive==="homenagem") parts.push("elementos pessoais do homenageado (data, objeto marcante ou caligrafia)");
    if(tags.motive==="expressao") parts.push("composição autoral combinando referência fotográfica e texturas");
    if(tags.motive==="atitude")   parts.push("ângulos marcantes e enquadramento forte para imponência");

    if(tags.music==="rock")     parts.push("texturas granuladas, luz de palco ou referência simbólica sutil");
    if(tags.music==="mpb")      parts.push("orgânico e poético: plantas brasileiras, traços suaves");
    if(tags.music==="pop")      parts.push("ícone cultural minimalista integrado ao motivo principal");
    if(tags.music==="rap")      parts.push("contraste alto e elementos urbanos discretos");
    if(tags.music==="classica") parts.push("tratamento de luz mais clássico e escultórico");

    return parts.length ? parts.join(". ") + "." : null;
  }

  // ===== ÁREAS: dor/visibilidade/indicação (KB interno) =====
  const AREAS_KB = {
    "antebraço interno": { pain:"baixa",  visibility:"media", beginner:true,  match:["antebraço","interno"] },
    "antebraço externo": { pain:"baixa",  visibility:"alta",  beginner:true,  match:["antebraço","externo"] },
    "bíceps":            { pain:"baixa",  visibility:"media", beginner:true,  match:["bíceps","braco","braço"] },
    "ombro":             { pain:"baixa",  visibility:"media", beginner:true,  match:["ombro","braco","braço"] },
    "coxa":              { pain:"baixa",  visibility:"media", beginner:true,  match:["coxa","perna"] },
    "panturrilha":       { pain:"baixa",  visibility:"media", beginner:true,  match:["panturrilha","perna"] },
    "alta das costas":   { pain:"baixa",  visibility:"baixa", beginner:true,  match:["costas","alta"] },
    "tórax/peito":       { pain:"media",  visibility:"media", beginner:"ok",  match:["peito","tórax","torax"] },
    "costela":           { pain:"alta",   visibility:"baixa", beginner:false, match:["costela","lateral"] },
    "mão/punho":         { pain:"alta",   visibility:"alta",  beginner:false, match:["mão","mao","punho"] },
    "pescoço":           { pain:"alta",   visibility:"alta",  beginner:false, match:["pescoço","pescoco"] }
  };

  function matchesPreference(areaLabel, selectedAreas){
    const a = areaLabel.toLowerCase();
    return selectedAreas.some(sa=>{
      if(sa==="braco")    return /antebraço|bíceps|ombro/.test(a);
      if(sa==="perna")    return /coxa|panturrilha/.test(a);
      if(sa==="costas")   return /costas/.test(a);
      if(sa==="peito")    return /peito|tórax|torax/.test(a);
      if(sa==="costela")  return /costela|lateral/.test(a);
      if(sa==="mao")      return /mão|mao|punho/.test(a);
      if(sa==="pescoco")  return /pescoço|pescoco/.test(a);
      return false;
    });
  }
  function kbOf(areaLabel){
    const k = areaLabel.toLowerCase();
    let foundKey = Object.keys(AREAS_KB).find(key=> k.startsWith(key));
    if(foundKey) return AREAS_KB[foundKey];
    return Object.entries(AREAS_KB).find(([key])=>k.includes(key))?.[1] || null;
  }
  function scoreArea(areaLabel, tags, prefs){
    const meta = kbOf(areaLabel) || {};
    let s = 0;
    if (prefs.length && matchesPreference(areaLabel, prefs)) s += 5;
    if (tags.first && meta.pain==="baixa") s += 2;
    if (tags.first && meta.pain==="alta")  s -= 2;
    if (tags.pain==="baixa" && meta.pain!=="baixa") s -= 1;
    if (tags.work==="formal"){
      if (/(mão|mao|punho|pescoço|pescoco|antebraço externo)/i.test(areaLabel)) s -= 3;
      if (/(costas|costela|peito|tórax|torax)/i.test(areaLabel)) s += 1;
    }
    if (tags.volu==="alta"){
      if (/(costas|costela|coxa|peito|tórax|torax)/i.test(areaLabel)) s += 1;
      if (/(antebraço externo|mão|mao|pescoço|pescoco)/i.test(areaLabel)) s -= 1;
    }
    if (tags.presence==="impactante"){
      if (/(peito|tórax|torax|bíceps|antebraço externo|alta das costas|ombro)/i.test(areaLabel)) s += 2;
    }
    if (tags.vis==="alta"  && /(antebraço externo|mão|mao|pescoço|pescoco)/i.test(areaLabel)) s += 1;
    if (tags.vis==="baixa" && /(costas|costela|coxa|peito|tórax|torax)/i.test(areaLabel)) s += 1;
    return s;
  }
  function pickPlacement(basePlacements, tags, answers){
    const prefs=(answers["areas"]||[]).map(o=>o.tags?.area).filter(a=>a && a!=="nenhuma");
    let candidates=[...new Set([...basePlacements, ...Object.keys(AREAS_KB)])];

    if (prefs.length){
      const preferidos = candidates.filter(c=>matchesPreference(c, prefs));
      if (preferidos.length){
        const seguros = preferidos.filter(c=>{
          const meta = kbOf(c);
          return !(meta?.pain==="alta" && tags.pain==="baixa");
        });
        if (seguros.length){
          candidates = [...new Set([...seguros, ...candidates])];
        }
      }
    }
    candidates.sort((a,b)=>scoreArea(b,tags,prefs)-scoreArea(a,tags,prefs));

    const primary=candidates[0];
    const alts = candidates.slice(1).filter(x=>x!==primary).slice(0,2);

    const reasons=[];
    const mPrim = kbOf(primary)||{};
    if (prefs.length && matchesPreference(primary,prefs)) reasons.push("respeita sua preferência de área");
    if (tags.first && mPrim?.pain==="baixa") reasons.push("conforto para primeira tatuagem");
    if (tags.presence==="impactante") reasons.push("garante presença visual");
    if (tags.work==="formal") reasons.push("permite maior discrição no trabalho");

    return {primary, alts, reasons};
  }

  // ===== SERIALIZAÇÃO =====
  function serializeAnswersForSubmit(Q, answers) {
    const out = {};
    Q.forEach(q=>{
      const v = answers[q.id];
      if(!v) return;
      if(q.type === "text"){
        out[q.id] = v.value || "";
      } else if(q.type === "single"){
        out[q.id] = v.label || "";
        out[q.id+"_tags"] = v.tags || {};
      } else if(q.type === "multi"){
        const arr = Array.isArray(v) ? v : [];
        out[q.id] = arr.map(o=>o.label).join("; ");
        out[q.id+"_tags"] = arr.map(o=>o.tags||{});
      }
    });
    return out;
  }
  const safeJSON = (obj)=> JSON.stringify(obj).replace(/</g, '\\u003C');

  // ===== ENVIOS & DEDUPE & FLATTEN =====
  function lsGet(k){ try{return localStorage.getItem(k);}catch(e){return null;} }
  function lsSet(k,v){ try{localStorage.setItem(k,v);}catch(e){} }
  function makeKey(prefix, obj){
    const s = JSON.stringify(obj || {});
    let h = 0;
    for(let i=0;i<s.length;i++) h = (h*31 + s.charCodeAt(i)) >>> 0;
    return prefix + ":" + h;
  }

  function flattenAllForFormspree(REC, RAW){
    const flat = {
      theme: (REC.themes && REC.themes[0]) || "",
      alt_themes: (REC.themes || []).slice(1,4).join(" | "),
      placement: REC.placement || "",
      placement_alt1: (REC.placementAlts && REC.placementAlts[0]) || "",
      placement_alt2: (REC.placementAlts && REC.placementAlts[1]) || "",
      sizeLabel: REC.sizeLabel || "",
      sizeCm: REC.sizeCm || "",
      persona: REC.persona || "",
      hoursEstimate: REC.hours || "",
      priceEstimate: REC.priceEstimate || "",
      tema_principal: REC.temaPrincipal || "",
      alternativas_txt: Array.isArray(REC.alternativasTxt) ? REC.alternativasTxt.join(" | ") : (REC.alternativasTxt || "")
    };
    Object.keys(RAW||{}).forEach(k=>{
      if(!k.endsWith("_tags")) flat["q_"+k] = RAW[k];
    });
    Object.entries(RAW||{}).forEach(([k,v])=>{
      if(!k.endsWith("_tags")) return;
      if(Array.isArray(v)){
        const codes = [];
        v.forEach(obj=>{
          Object.entries(obj||{}).forEach(([kk,vv])=>{
            if(kk==="area"){ codes.push(String(vv)); }
          });
        });
        if(codes.length){
          flat["tag_areas"] = codes.join(" | ");
          const ALL = ["braco","perna","costas","peito","costela","mao","pescoco","nenhuma"];
          ALL.forEach(a=>{ flat["area_"+a] = codes.includes(a) ? 1 : ""; });
        }
      }else if(v && typeof v==="object"){
        Object.entries(v).forEach(([kk,vv])=>{
          flat["tag_"+kk] = vv;
        });
      }
    });
    const rt = REC.tags || {};
    ["motive","universe","vis","work","pain","session","day","period","budgetMin","budgetMax","tribute","presence","astro","values","music","first","volu","prefStyle"]
      .forEach(k=>{
        if(flat["tag_"+k]==null && rt[k]!=null) flat["tag_"+k]=rt[k];
      });
    return flat;
  }

  function sendPayload(data){
    const endpoint = FORMSPREE_ENDPOINT || "https://formspree.io/f/mvgblrjq";
    if(!endpoint) return;
    const flat = flattenAllForFormspree(data.resumo || {}, data.respostas || {});
    fetch(endpoint,{
      method:"POST",
      headers:{"Content-Type":"application/json","Accept":"application/json"},
      body:JSON.stringify({
        ts:new Date().toISOString(),
        ...data,
        ...flat
      })
    }).catch(()=>{});
  }

  // ===== UI FLOW =====
  const app=document.getElementById("app");
  let step=0;
  const answers={};
  const total=Q.length;
  let finished=false;

  function recommend(ans){
    const tags={};
    Object.values(ans).forEach(v=>{
      if(!v) return;
      if(Array.isArray(v)) v.forEach(o=>Object.assign(tags,o.tags||{}));
      else Object.assign(tags, v.tags||{});
    });

    const persona=tags.persona||"artistico";
    const universe=tags.universe;

    let themes=[...(THEME_BY_PERSONA[persona]||THEME_BY_PERSONA.artistico)];
    if(universe && CULTURE_MOD[universe]) themes=themes.concat(CULTURE_MOD[universe]);
    if(tags.tribute==="pessoa") themes.unshift("retrato de pessoa querida");
    if(tags.tribute==="pet")    themes.unshift("retrato do seu pet");
    if(tags.tribute==="fe")     themes.unshift("símbolo de fé/proteção");

    // locais base por visibilidade
    let visKey=tags.vis||"media";
    let basePlacements=[...(PLACEMENTS[visKey]||PLACEMENTS.media)];
    if(tags.first) basePlacements=["antebraço interno","panturrilha","ombro",...basePlacements];
    if(tags.volu==="alta") basePlacements=[...LESS_SEEN,...basePlacements];
    if(tags.work==="formal" && visKey!=="baixa") basePlacements=[...LESS_SEEN,...PLACEMENTS.baixa];
    if(tags.pain==="baixa") basePlacements=[...basePlacements.filter(p=>LOW_PAIN.some(lp=>p.includes(lp))),...basePlacements];

    // seleção com pontuação (prioriza Q12 quando seguro)
    const picked = pickPlacement(basePlacements, tags, ans);

    // tamanho/orçamento
    const inv=ans["investimento"]?.tags || {budgetMin:600,budgetMax:1200};
    let hours=hoursFromBudget(inv.budgetMin,inv.budgetMax);
    const multi=ans["tempoSessao"]?.tags?.session==="multi" || inv.budgetMin>=2500;
    let size=sizeFromTime(hours,multi);

    // cap suave para primeira tatuagem
    if (tags.first && size.size==="grande"){
      const wantsImpact = tags.presence==="impactante";
      const longSession = ans["tempoSessao"]?.label?.includes("5–6h") || ans["tempoSessao"]?.tags?.session==="longa" || ans["tempoSessao"]?.tags?.session==="multi";
      if (!(wantsImpact && longSession)) {
        size = {size:"medio", label:"Médio"};
        const MAX_H_MEDIO = 4;
        if (hours > MAX_H_MEDIO) hours = MAX_H_MEDIO;
      }
    }

    const cm = SIZE_CM[size.size];
    const priceEstimate = Math.round(hours * HOURLY);

    // justificativa (inclui razões do picker)
    const just = [];
    picked.reasons.forEach(r=>just.push(r));
    if(tags.pain==="baixa") just.push("buscamos região de menor sensibilidade");
    if(tags.work==="formal") just.push("considera discrição no trabalho");
    if(tags.volu==="alta")  just.push("evita ficar no campo de visão constante");
    const justification = `${just.length? just.join(" · "):"equilíbrio entre conforto e estética"} — tamanho aproximado ${cm} (${size.label}).`;

    const inspiration = buildInspiration(tags);

    return {
      persona,
      themes:[...new Set(themes)].slice(0,4),
      placementsAll: [picked.primary, ...picked.alts],
      placementPrimary: picked.primary || "antebraço interno",
      placementAlts: picked.alts || [],
      sizeLabel:size.label,
      sizeCm:cm,
      hours,
      priceEstimate,
      justification,
      inspiration,
      tone:tone(persona),
      tags,
      budget: {min: inv.budgetMin, max: inv.budgetMax}
    };
  }

  function finishOnce(){
    if(finished) return;
    finished = true;

    const r = recommend(answers);
    const nome = (answers.nome?.value||"Você");

    const wording = composeThemeText(r.tags);
    const temaPrincipal = wording.frase;
    const alternativasTema = wording.alts;
    const alternativasTemaTxt = alternativasTema.join(" · ");

    const RAW_OBJ = serializeAnswersForSubmit(Q, answers);
    const REC_OBJ = {
      themes: r.themes,
      placement: r.placementPrimary,
      placementAlts: r.placementAlts,
      sizeLabel: r.sizeLabel,
      sizeCm: r.sizeCm,
      hours: r.hours,
      priceEstimate: r.priceEstimate,
      justification: r.justification,
      inspiration: r.inspiration,
      persona: r.persona,
      tags: r.tags,
      temaPrincipal,
      alternativasTxt: alternativasTema
    };

    // envio automático com dedupe
    const autoKey = makeKey("auto", {REC_OBJ, RAW_OBJ});
    if (!lsGet(autoKey)) {
      sendPayload({
        source:"auto-finish",
        nome: (answers.nome?.value||""),
        contato: null,
        resumo: REC_OBJ,
        respostas: RAW_OBJ,
        ua: navigator.userAgent
      });
      lsSet(autoKey,"1");
    }

    const altLocais = (r.placementAlts||[]).join(" · ");
    const tamanhoLinha = `${r.sizeLabel} — ${r.sizeCm} — estimado R$ ${r.priceEstimate.toLocaleString("pt-BR")} (~${r.hours}h)`;
    const txtResumo = `${nome} — Tema: ${temaPrincipal} | Local: ${r.placementPrimary}${r.placementAlts && r.placementAlts[0] ? (" ("+r.placementAlts[0]+")"):""} | Tamanho: ${r.sizeLabel} (${r.sizeCm}) | Estimado: R$ ${r.priceEstimate.toLocaleString("pt-BR")}`;

    const html =
`<!doctype html><html lang="pt-br"><head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Sugestão personalizada</title>
<style>
  :root{--bg:#f7f7f8;--card:#fff;--ink:#111;--muted:#666;--line:#e6e6e8;--radius:16px;--accent:#7A8B55;--accent-ink:#fff}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,sans-serif}
  .wrap{max-width:860px;margin:0 auto;padding:24px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:0 6px 16px rgba(0,0,0,.04);padding:20px}
  .title{font-size:22px;margin:0 0 10px}
  .kicker{font-size:12px;text-transform:uppercase;color:var(--muted);margin-top:14px}
  .row{display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:720px){.row2{grid-template-columns:1fr 1fr}}
  .btn{appearance:none;border:1px solid var(--accent);background:var(--accent);color:var(--accent-ink);border-radius:12px;padding:12px 14px;text-align:center;cursor:pointer}
  .btn:focus-visible{outline:2px solid var(--accent);outline-offset:2px}
  input[type="text"]{width:100%;padding:12px;border:1px solid #d9d9df;border-radius:12px}
  .muted{color:#666}
</style>
</head><body>
<div class="wrap">
  <div class="card">
    <div class="title">${nome}, sua sugestão personalizada 🎨</div>

    <div class="kicker">Tema recomendado</div>
    <div style="font-size:18px;margin-top:4px">${temaPrincipal}</div>
    <div class="muted" style="margin-top:4px">Alternativas: ${alternativasTema.join(" · ")}</div>

    <div class="kicker">Local ideal</div>
    <div style="font-size:18px;margin-top:4px">${r.placementPrimary}</div>
    ${altLocais ? `<div class="muted" style="margin-top:4px">Alternativas de local: ${altLocais}</div>` : ""}

    <div class="kicker">Tamanho e estimativa</div>
    <div style="font-size:16px;margin-top:4px">${tamanhoLinha}</div>

    <div class="kicker">Justificativa</div>
    <div class="muted" style="margin-top:6px">${r.justification}</div>

    ${r.inspiration ? `
      <div class="kicker">Inspiração adicional</div>
      <div style="font-size:16px;margin-top:4px">${r.inspiration}</div>` : ""}

    <div class="row row2" style="margin-top:14px">
      <a class="btn" href="https://
