function render(){
  app.innerHTML = "";
  const q = Q[step];

  const prog = el("div", { class: "prog" }, 
    el("i", { style: `width:${Math.round(((step+1)/total)*100)}%` })
  );

  const card = el("div", { class: "card" },
    el("div", { class: "title" }, q.t),
    q.helper ? el("div", { class: "muted" }, q.helper) : null,
  );

  if(q.type === "text"){
    const input = el("input", { type:"text", placeholder:q.ph||"", value:answers[q.id]?.value||"" });
    input.addEventListener("input", ()=> answers[q.id] = { value: input.value, tags:{} });

    const actions = el("div", { class:"actions" },
      el("button", { class:"btn", onClick:()=>{ step=Math.max(0,step-1); render(); } }, "Voltar"),
      el("button", { class:"btn primary", onClick:()=>{
        if(q.req && !input.value.trim()){ alert("Digite seu nome"); return; }
        if(input.value.trim()) answers[q.id]={value:input.value.trim(),tags:{}};
        if(step === total-1){ finishOnce(); return; }
        step = Math.min(total-1, step+1);
        render();
      } }, "Avançar"),
    );

    card.append(el("div",{class:"row"},input), actions);

  } else if(q.type === "single"){
    const selected = answers[q.id]?.__chosen ?? null;
    const list = el("div", { class:"row row2" });
    q.options.forEach((opt,idx)=>{
      const isSel = selected===idx;
      list.appendChild(
        el("button",{
          class:"btn"+(isSel?" sel":""),
          "aria-pressed": String(!!isSel),
          onClick:()=>{ answers[q.id]={...opt,__chosen:idx}; render(); }
        }, opt.label)
      );
    });
    const canNext = answers[q.id] && answers[q.id].__chosen != null;
    const actions = el("div",{class:"actions"},
      el("button",{class:"btn",onClick:()=>{step=Math.max(0,step-1);render();}}, "Voltar"),
      el("button",{class:"btn primary",disabled:!canNext,onClick:()=>{
        if(!canNext) return;
        if(step === total-1){ finishOnce(); return; }
        step=Math.min(total-1,step+1);
        render();
      }}, "Avançar")
    );
    card.append(list, actions);

  } else if(q.type === "multi"){
    const current = Array.isArray(answers[q.id]) ? answers[q.id] : [];
    const list = el("div", { class:"row row2" });
    q.options.forEach(opt=>{
      const isSel = !!current.find(o=>o.label===opt.label);
      list.appendChild(el("button",{
        class:"btn"+(isSel?" sel":""),
        "aria-pressed": String(isSel),
        onClick:()=>{
          const arr = Array.isArray(answers[q.id]) ? [...answers[q.id]] : [];
          const i = arr.findIndex(o=>o.label===opt.label);
          if(i>=0) arr.splice(i,1); else arr.push(opt);
          answers[q.id]=arr; render();
        }}, opt.label));
    });
    const actions = el("div", { class:"actions" },
      el("button", { class:"btn", onClick:()=>{ step=Math.max(0,step-1); render(); } }, "Voltar"),
      el("button", { class:"btn primary", onClick:()=>{
        if(step === total-1){ finishOnce(); return; }
        step=Math.min(total-1,step+1); render();
      } }, "Avançar"),
    );
    card.append(list, actions);
  }

  app.append(prog, card);
}
