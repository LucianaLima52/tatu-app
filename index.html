<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Qual √© a tatuagem certa pra voc√™?</title>
  <style>
    :root{
      --bg:#f7f7f8; --card:#fff; --ink:#111; --muted:#666; --line:#e6e6e8;
      --radius:16px; --accent:#7A8B55; --accent-ink:#fff;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,sans-serif;background:var(--bg);color:var(--ink)}
    .wrap{max-width:860px;margin:0 auto;padding:24px}
    header h1{font-size:clamp(22px,2.8vw,34px);margin:10px 0 4px}
    header p{color:var(--muted);margin:0 0 12px;font-size:clamp(14px,2vw,18px)}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:0 6px 16px rgba(0,0,0,.04);padding:20px}
    .row{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:720px){.row2{grid-template-columns:1fr 1fr}}
    .title{font-size:20px;margin:0 0 6px}
    .muted{color:var(--muted);font-size:13px}
    .btn{appearance:none;border:1px solid var(--line);background:#fff;color:var(--ink);border-radius:12px;padding:12px 14px;text-align:left;cursor:pointer;transition:.2s;word-break:break-word}
    .btn:hover{border-color:#111}
    .btn.primary{text-align:center;background:var(--accent);color:var(--accent-ink);border-color:var(--accent)}
    .btn.block{width:100%}
    .btn.sel{border-color:var(--accent)}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .btn:focus-visible{outline:2px solid var(--accent);outline-offset:2px}
    .actions{display:flex;justify-content:space-between;gap:10px;margin-top:10px}
    .prog{height:8px;background:#e9e9ec;border-radius:999px;overflow:hidden;margin:10px 0 16px}
    .prog>i{display:block;height:100%;background:var(--accent);width:0}
    input[type="text"]{width:100%;padding:12px;border:1px solid #d9d9df;border-radius:12px}
    .kicker{font-size:12px;text-transform:uppercase;color:var(--muted);margin-top:14px}
    .footer{margin:24px 0 10px;text-align:center;color:#888;font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Qual √© a tatuagem certa pra voc√™?</h1>
      <p>Responda algumas perguntas r√°pidas e descubra o desenho, o tamanho e o local perfeitos para o seu estilo.</p>
    </header>

<!-- index.html de teste -->
<div id="app">carregando‚Ä¶</div>
<script src="app.js"></script>

// app.js de teste
document.getElementById('app').textContent = 'JS OK';
// ===== CONFIG =====
const HOURLY = 150; // R$/hora (interno)
const FORMSPREE_ENDPOINT = "https://formspree.io/f/mvgblrjq";

// ===== UTM CAPTURE =====
const UTM = (() => {
  const p = new URLSearchParams(location.search);
  return {
    source: p.get("utm_source") || "",
    medium: p.get("utm_medium") || "",
    campaign: p.get("utm_campaign") || ""
  };
})();

// ===== UTIL =====
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
const el = (tag, attrs = {}, ...kids) => {
  const n = document.createElement(tag);
  if (tag === "button" && !("type" in attrs)) n.setAttribute("type","button");
  const boolAttrs = new Set(["disabled","checked","selected","readonly","multiple","required","autofocus","hidden"]);
  Object.entries(attrs).forEach(([k,v])=>{
    if (k==="class") n.className = v;
    else if (k==="html") n.innerHTML = v;
    else if (k.startsWith("on")) n.addEventListener(k.slice(2).toLowerCase(), v);
    else if (boolAttrs.has(k)) { if (v) n.setAttribute(k,""); else n.removeAttribute(k); }
    else if (v !== false && v != null) n.setAttribute(k, String(v));
  });
  kids.forEach(k=>{ if(k==null) return; n.appendChild(typeof k==="string"?document.createTextNode(k):k); });
  return n;
};
function lsGet(k){ try{return localStorage.getItem(k);}catch(e){return null;} }
function lsSet(k,v){ try{localStorage.setItem(k,v);}catch(e){} }
function makeKey(prefix, obj){
  const s = JSON.stringify(obj || {});
  let h = 0;
  for(let i=0;i<s.length;i++) h = (h*31 + s.charCodeAt(i)) >>> 0;
  return `${prefix}:${h}`;
}

// ===== PERGUNTAS =====
const Q = [
  { id:"nome", t:"Qual √© o seu nome?", type:"text", req:false, ph:"Digite seu nome" },

  { id:"experiencia", t:"Voc√™ j√° tem tatuagens ou seria a sua primeira?", type:"single",
    options:[
      {label:"Ser√° minha primeira ‚Äî ainda tenho algumas d√∫vidas e receios.", tags:{first:true}},
      {label:"J√° tenho ‚Äî quero complementar ou fazer algo novo.",           tags:{first:false}},
    ]},

  { id:"receio", t:"Qual √© o seu maior receio em rela√ß√£o √† tatuagem?", type:"single",
    options:[
      {label:"Arrependimento",tags:{fear:"arrependimento"}},
      {label:"Julgamento",    tags:{fear:"julgamento"}},
      {label:"Dor",           tags:{fear:"dor"}},
      {label:"Custo",         tags:{fear:"custo"}},
      {label:"Nenhum",        tags:{fear:"nenhum"}},
    ]},

  { id:"perfil", t:"Qual dessas descri√ß√µes mais combina com voc√™?", type:"single",
    options:[
      {label:"Aut√™ntico(a) / Criativo(a) ‚Äî tatuagem como arte no corpo.", tags:{persona:"artistico"}},
      {label:"Rom√¢ntico(a) / Emocional ‚Äî valorizo sentimentos e mem√≥rias.", tags:{persona:"romantico"}},
      {label:"Rebelde / Questionador(a) ‚Äî for√ßa e atitude.", tags:{persona:"rebelde"}},
      {label:"Espiritual / M√≠stico(a) ‚Äî conex√£o e prote√ß√£o.", tags:{persona:"mistico"}},
      {label:"Social / Est√©tico(a) ‚Äî moda, cultura pop, identidade de grupo.", tags:{persona:"social"}},
    ]},

  { id:"comunicar", t:"O que voc√™ mais quer comunicar com essa tatuagem?", type:"single",
    options:[
      {label:"Poder me expressar",           tags:{motive:"expressao"}},
      {label:"Homenagem",                    tags:{motive:"homenagem"}},
      {label:"Posicionamento e confronto",   tags:{motive:"atitude"}},
      {label:"F√©/Prop√≥sito",                 tags:{motive:"fe"}},
      {label:"Est√©tica",                     tags:{motive:"estetica"}},
    ]},

  { id:"estilo", t:"Qual estilo mais combina com voc√™? (calibra linguagem)", type:"single",
    options:[
      {label:"Fine Line ‚Äî tra√ßos finos e minimalistas", tags:{prefStyle:"fineline"}},
      {label:"Blackwork ‚Äî preto intenso e contrastes",  tags:{prefStyle:"blackwork"}},
      {label:"Realismo",                                tags:{prefStyle:"realismo"}},
    ]},

  { id:"universo", t:"Qual universo est√©tico mais combina com voc√™?", type:"single",
    options:[
      {label:"Cl√°ssico: est√©tica inspirada na arte greco-romana e renascentista", tags:{universe:"classico"}},
      {label:"Pop-Geek: universo de cultura pop (HQs, games, anime)",             tags:{universe:"pop"}},
      {label:"Natureza: foco em flora, fauna e paisagens",                        tags:{universe:"natureza"}},
      {label:"Mitologia: deuses, criaturas e s√≠mbolos arquet√≠picos",              tags:{universe:"mitologia"}},
      {label:"Figuras humanas e personagens",                                     tags:{universe:"retrato"}},
    ]},

  { id:"visibilidade", t:"Voc√™ quer que sua tatuagem apare√ßa no dia a dia?", type:"single",
    options:[
      {label:"Discreta",    tags:{vis:"baixa"}},
      {label:"Moderada",    tags:{vis:"media"}},
      {label:"Bem vis√≠vel", tags:{vis:"alta"}},
    ]},

  { id:"trabalho", t:"Como √© o seu ambiente de trabalho em rela√ß√£o a tatuagens?", type:"single",
    options:[
      {label:"Formal",  tags:{work:"formal"}},
      {label:"H√≠brido", tags:{work:"hibrido"}},
      {label:"Liberal", tags:{work:"liberal"}},
    ]},

  { id:"volubilidade", t:"Voc√™ enjoa f√°cil de coisas visuais?", type:"single",
    options:[
      {label:"Sim ‚Äî prefiro n√£o ver o tempo todo", tags:{volu:"alta"}},
      {label:"Mais ou menos",                      tags:{volu:"media"}},
      {label:"N√£o",                                tags:{volu:"baixa"}},
    ]},

  { id:"dor", t:"Como voc√™ lida com dor durante procedimentos?", type:"single",
    options:[
      {label:"Baixa toler√¢ncia", tags:{pain:"baixa"}},
      {label:"M√©dia",            tags:{pain:"media"}},
      {label:"Alta toler√¢ncia",  tags:{pain:"alta"}},
    ]},

  { id:"tempoSessao", t:"Quanto tempo voc√™ topa ficar em uma sess√£o?", type:"single",
    options:[
      {label:"1‚Äì2h",               tags:{session:"curta"}},
      {label:"3‚Äì4h",               tags:{session:"media"}},
      {label:"5‚Äì6h",               tags:{session:"longa"}},
      {label:"Mais de uma sess√£o", tags:{session:"multi"}},
    ]},

  { id:"diaSemana", t:"Dias preferidos para tatuar", type:"single",
    options:[
      {label:"Dias √∫teis",       tags:{day:"uteis"}},
      {label:"Finais de semana", tags:{day:"fds"}},
      {label:"Qualquer",         tags:{day:"qualquer"}},
    ]},

  { id:"periodoDia", t:"Per√≠odo do dia preferido", type:"single",
    options:[
      {label:"Manh√£",       tags:{period:"manha"}},
      {label:"Tarde",       tags:{period:"tarde"}},
      {label:"Noite",       tags:{period:"noite"}},
      {label:"Indiferente", tags:{period:"indiferente"}},
    ]},

  { id:"investimento", t:"Qual faixa de investimento voc√™ considera? (interno, n√£o exibimos valores)", type:"single",
    options:[
      {label:"R$ 150 ‚Äì R$ 600",     tags:{budgetMin:150,budgetMax:600}},
      {label:"R$ 600 ‚Äì R$ 1.200",   tags:{budgetMin:600,budgetMax:1200}},
      {label:"R$ 1.200 ‚Äì R$ 2.500", tags:{budgetMin:1200,budgetMax:2500}},
      {label:"A partir de R$ 2.500",tags:{budgetMin:2500,budgetMax:999999}},
    ]},

  { id:"homenagem", t:"Sua tatuagem seria uma homenagem?", type:"single",
    options:[
      {label:"Pessoa querida",      tags:{tribute:"pessoa"}},
      {label:"Pet",                 tags:{tribute:"pet"}},
      {label:"F√©/Espiritualidade",  tags:{tribute:"fe"}},
      {label:"Talvez",              tags:{tribute:"talvez"}},
      {label:"N√£o",                 tags:{tribute:"nao"}},
    ]},

  { id:"presenca", t:"Quando algu√©m olhar para a sua tatuagem, que rea√ß√£o voc√™ quer provocar?", type:"single",
    options:[
      {label:"Discreta (quase impercept√≠vel / elegante)",         tags:{presence:"discreta"}},
      {label:"Convers√°vel (gera curiosidade e di√°logo)",          tags:{presence:"equilibrada"}},
      {label:"Protagonista (marca presen√ßa forte / manifesto)",   tags:{presence:"impactante"}},
    ]},

  { id:"areas", t:"√Åreas preferidas (opcional)", type:"multi",
    options:[
      {label:"Bra√ßo (antebra√ßo/b√≠ceps/ombro)", tags:{area:"braco"}},
      {label:"Perna (coxa/panturrilha)",       tags:{area:"perna"}},
      {label:"Costas (alta ou m√©dia)",         tags:{area:"costas"}},
      {label:"T√≥rax/Peito",                    tags:{area:"peito"}},
      {label:"Costela/Lateral",                tags:{area:"costela"}},
      {label:"M√£o/Punho",                      tags:{area:"mao"}},
      {label:"Pesco√ßo",                        tags:{area:"pescoco"}},
      {label:"Sem prefer√™ncia",                tags:{area:"nenhuma"}},
    ]},

  { id:"astrologia", t:"Inspira√ß√£o astrol√≥gica? (opcional)", type:"single",
    options:[
      {label:"N√£o",   tags:{astro:null}},
      {label:"Elemento √°gua (c√¢ncer, escorpi√£o, peixes): ondas, lua, √°gua-viva, concha", tags:{astro:"agua"}},
      {label:"Elemento fogo (√°ries, le√£o, sagit√°rio): chamas, sol, f√™nix, vulc√£o",       tags:{astro:"fogo"}},
      {label:"Elemento terra (touro, virgem, capric√≥rnio): montanhas, √°rvore, cristal, espiga de trigo", tags:{astro:"terra"}},
      {label:"Elemento ar (g√™meos, libra, aqu√°rio): nuvens, p√°ssaros, dente-de-le√£o, linhas de vento",   tags:{astro:"ar"}},
    ]},

  { id:"valores", t:"Quais s√≠mbolos voc√™ gostaria de acrescentar √† sua tatuagem?", type:"single",
    options:[
      {label:"Sem s√≠mbolos",             tags:{values:null}},
      {label:"Arabescos e filigranas",   tags:{values:"autenticidade"}},
      {label:"Desenhos geom√©tricos",     tags:{values:"natureza"}},
      {label:"Elementos arquitet√¥nicos", tags:{values:"fe"}},
    ]},

  { id:"musica", t:"M√∫sica/cultura influencia? (opcional)", type:"single",
    options:[
      {label:"N√£o muito", tags:{music:null}},
      {label:"Rock",      tags:{music:"rock"}},
      {label:"MPB/Indie", tags:{music:"mpb"}},
      {label:"Pop",       tags:{music:"pop"}},
      {label:"Rap/Trap",  tags:{music:"rap"}},
      {label:"Cl√°ssica",  tags:{music:"classica"}},
    ]},
];

// ===== REGRAS =====
const THEME_BY_PERSONA = {
  romantico:["Celebra v√≠nculos afetivos com s√≠mbolos de amor, florais e frases delicadas"],
  rebelde:["Feita para desafiar padr√µes como caveira, chamas, pantera"],
  mistico:["Traduz a espiritualidade, intui√ß√£o e prote√ß√£o em s√≠mbolos esot√©ricos, fases da lua, sol, constela√ß√µes"],
  artistico:["Autoral: sua ideia transformada em uma composi√ß√£o √∫nica"],
  social:["Para visibilizar causas, identidades e pertencimentos como frases curtas, s√≠mbolos e grafismos"],
};
const CULTURE_MOD = {
  classico:["Propor√ß√£o e simetria com dramatismo escult√≥rico, inspirada na arte antiga/renascentista, enfatizando luz e sombra e ornamentos hist√≥ricos"],
  pop:["refer√™ncia cinematogr√°fica sutil","√≠cone pop em realismo"],
  natureza:["Retrata plantas, flores, folhas e ramos com √™nfase em formas org√¢nicas e detalhes naturais (nervuras, p√©talas, texturas)"],
  mitologia:["Representa deuses, her√≥is, criaturas e s√≠mbolos de mitos"],
  retrato:["Figura humana: representa√ß√£o de silhuetas, corpo em movimento, m√£os"],
};
const PLACEMENTS = { alta:["antebra√ßo externo","panturrilha","antebra√ßo interno"], media:["b√≠ceps","coxa","ombro"], baixa:["costela","t√≥rax/peito","alta das costas"] };
const LESS_SEEN=["costela","alta das costas","lateral de coxa"];
const LOW_PAIN=["antebra√ßo","coxa","panturrilha","ombro"];
const SIZE_CM = { pequeno:"6‚Äì9 cm", medio:"12‚Äì18 cm", grande:"20‚Äì30 cm", projeto:"√°rea maior em v√°rias sess√µes (40+ cm no total por √°rea)" };

const hoursFromBudget=(min,max)=>clamp(Math.round(((min+max)/2)/HOURLY),1,24);
function sizeFromTime(h,multi=false){
  if(multi||h>=8) return {size:"projeto",label:"Projeto"};
  if(h>=4) return {size:"grande",label:"Grande"};
  if(h>=2) return {size:"medio",label:"M√©dio"};
  return {size:"pequeno",label:"Pequeno"};
}
function tone(persona){
  switch(persona){
    case"romantico":return{themeLine:"um registro de afeto e mem√≥ria"};
    case"rebelde":return{themeLine:"presen√ßa e atitude"};
    case"mistico":return{themeLine:"significado e prote√ß√£o"};
    case"artistico":return{themeLine:"luz e sombra em arte pessoal"};
    case"social":return{themeLine:"estilo alinhado √† sua vibe"};
    default:return{themeLine:"estilo que representa quem voc√™ √©"};
  }
}

function buildInspiration(tags){
  const parts=[];
  if(tags.astro==="agua") parts.push("linhas fluidas e temas de √°gua (ondas, lua, conchas, √°gua-viva)");
  if(tags.astro==="fogo") parts.push("chamas, sol, f√™nix e contrastes mais quentes para energia");
  if(tags.astro==="terra") parts.push("montanhas, √°rvores e texturas minerais (cristais, gr√£o da pedra)");
  if(tags.astro==="ar") parts.push("composi√ß√£o leve com nuvens, p√°ssaros, dente-de-le√£o e linhas de vento");

  if(tags.values==="autenticidade") parts.push("ornamentos em arabescos e filigranas para eleg√¢ncia e fluxo");
  if(tags.values==="natureza")      parts.push("geometria (mandalas, padr√µes e formas modulares) como base est√©tica");
  if(tags.values==="fe")            parts.push("elementos arquitet√¥nicos (arcos, colunas, vitrais) como s√≠mbolo de estrutura e prop√≥sito");

  if(tags.motive==="homenagem") parts.push("elementos pessoais do homenageado (data, objeto marcante ou caligrafia)");
  if(tags.motive==="expressao") parts.push("composi√ß√£o autoral combinando refer√™ncia fotogr√°fica e texturas");
  if(tags.motive==="atitude")   parts.push("√¢ngulos marcantes e enquadramento forte para impon√™ncia");

  if(tags.music==="rock")     parts.push("texturas granuladas, luz de palco ou refer√™ncia simb√≥lica sutil");
  if(tags.music==="mpb")      parts.push("org√¢nico e po√©tico: plantas brasileiras, tra√ßos suaves");
  if(tags.music==="pop")      parts.push("√≠cone cultural minimalista integrado ao motivo principal");
  if(tags.music==="rap")      parts.push("contraste alto e elementos urbanos discretos");
  if(tags.music==="classica") parts.push("tratamento de luz mais cl√°ssico e escult√≥rico");

  return parts.length ? parts.join(". ") + "." : null;
}

// ===== KB interno =====
const KB = {
  astro: {
    fogo: { resumo: "aud√°cia e energia; luz dram√°tica e dire√ß√£o marcada" },
    terra:{ resumo: "forma e t√©cnica; texturas org√¢nicas e estabilidade" },
    ar:   { resumo: "leveza e movimento; composi√ß√£o arejada" },
    agua: { resumo: "emo√ß√£o e intui√ß√£o; transi√ß√µes suaves e fluidez" }
  },
  values: {
    autenticidade: { texto:"ornamentos em arabescos/filigranas", toque:"eleg√¢ncia fluida" },
    natureza:      { texto:"geometria/mandalas e padr√µes",       toque:"ordem e ritmo"    },
    fe:            { texto:"elementos arquitet√¥nicos",            toque:"estrutura e prop√≥sito" }
  },
  motive: {
    expressao: "refor√ßar autoria e sentimento",
    homenagem: "registrar carinho e mem√≥ria",
    atitude:   "afirmar posicionamento",
    fe:        "representar prop√≥sito/espiritualidade",
    estetica:  "valorizar harmonia e forma"
  },
  persona: {
    romantico: "tom afetivo e po√©tico",
    rebelde:   "tom incisivo e desafiador",
    mistico:   "tom simb√≥lico e protetor",
    artistico: "tom autoral e de estudo de luz",
    social:    "tom identit√°rio e de pertencimento"
  }
};

// ===== √ÅREAS: dor/visibilidade/indica√ß√£o =====
const AREAS_KB = {
  "antebra√ßo interno": { pain:"baixa",  visibility:"media", beginner:true,  match:["antebra√ßo","interno"] },
  "antebra√ßo externo": { pain:"baixa",  visibility:"alta",  beginner:true,  match:["antebra√ßo","externo"] },
  "b√≠ceps":            { pain:"baixa",  visibility:"media", beginner:true,  match:["b√≠ceps","braco","bra√ßo"] },
  "ombro":             { pain:"baixa",  visibility:"media", beginner:true,  match:["ombro","braco","bra√ßo"] },
  "coxa":              { pain:"baixa",  visibility:"media", beginner:true,  match:["coxa","perna"] },
  "panturrilha":       { pain:"baixa",  visibility:"media", beginner:true,  match:["panturrilha","perna"] },
  "alta das costas":   { pain:"baixa",  visibility:"baixa", beginner:true,  match:["costas","alta"] },
  "t√≥rax/peito":       { pain:"media",  visibility:"media", beginner:"ok",  match:["peito","t√≥rax","torax"] },
  "costela":           { pain:"alta",   visibility:"baixa", beginner:false, match:["costela","lateral"] },
  "m√£o/punho":         { pain:"alta",   visibility:"alta",  beginner:false, match:["m√£o","mao","punho"] },
  "pesco√ßo":           { pain:"alta",   visibility:"alta",  beginner:false, match:["pesco√ßo","pescoco"] }
};
function matchesPreference(areaLabel, selectedAreas){
  const a = areaLabel.toLowerCase();
  return selectedAreas.some(sa=>{
    if(sa==="braco")    return /antebra√ßo|b√≠ceps|ombro/.test(a);
    if(sa==="perna")    return /coxa|panturrilha/.test(a);
    if(sa==="costas")   return /costas/.test(a);
    if(sa==="peito")    return /peito|t√≥rax|torax/.test(a);
    if(sa==="costela")  return /costela|lateral/.test(a);
    if(sa==="mao")      return /m√£o|mao|punho/.test(a);
    if(sa==="pescoco")  return /pesco√ßo|pescoco/.test(a);
    return false;
  });
}
function kbOf(areaLabel){
  const k = areaLabel.toLowerCase();
  let found = AREAS_KB[Object.keys(AREAS_KB).find(key=> k.startsWith(key))];
  if(found) return found;
  return Object.entries(AREAS_KB).find(([key])=>k.includes(key))?.[1] || null;
}
function scoreArea(areaLabel, tags, prefs){
  const meta = kbOf(areaLabel) || {};
  let s = 0;
  if (prefs.length && matchesPreference(areaLabel, prefs)) s += 5;
  if (tags.first && meta.pain==="baixa") s += 2;
  if (tags.first && meta.pain==="alta")  s -= 2;
  if (tags.pain==="baixa" && meta.pain!=="baixa") s -= 1;
  if (tags.work==="formal"){
    if (/(m√£o|mao|punho|pesco√ßo|pescoco|antebra√ßo externo)/i.test(areaLabel)) s -= 3;
    if (/(costas|costela|peito|t√≥rax|torax)/i.test(areaLabel)) s += 1;
  }
  if (tags.volu==="alta"){
    if (/(costas|costela|coxa|peito|t√≥rax|torax)/i.test(areaLabel)) s += 1;
    if (/(antebra√ßo externo|m√£o|mao|pesco√ßo|pescoco)/i.test(areaLabel)) s -= 1;
  }
  if (tags.presence==="impactante"){
    if (/(peito|t√≥rax|torax|b√≠ceps|antebra√ßo externo|alta das costas|ombro)/i.test(areaLabel)) s += 2;
  }
  if (tags.vis==="alta"  && /(antebra√ßo externo|m√£o|mao|pesco√ßo|pescoco)/i.test(areaLabel)) s += 1;
  if (tags.vis==="baixa" && /(costas|costela|coxa|peito|t√≥rax|torax)/i.test(areaLabel)) s += 1;
  return s;
}
function pickPlacement(basePlacements, tags, answers){
  const prefs=(answers["areas"]||[]).map(o=>o.tags?.area).filter(a=>a && a!=="nenhuma");
  let candidates=[...new Set([...basePlacements, ...Object.keys(AREAS_KB)])];
  if (prefs.length){
    const preferidos = candidates.filter(c=>matchesPreference(c, prefs));
    if (preferidos.length){
      const seguros = preferidos.filter(c=>{
        const meta = kbOf(c);
        return !(meta?.pain==="alta" && tags.pain==="baixa");
      });
      if (seguros.length){
        candidates = [...new Set([...seguros, ...candidates])];
      }
    }
  }
  candidates.sort((a,b)=>scoreArea(b,tags,prefs)-scoreArea(a,tags,prefs));
  const primary=candidates[0];
  const alts = candidates.slice(1).filter(x=>x!==primary).slice(0,2);

  const reasons=[];
  const mPrim = kbOf(primary)||{};
  if (prefs.length && matchesPreference(primary,prefs)) reasons.push("respeita sua prefer√™ncia de √°rea");
  if (tags.first && mPrim?.pain==="baixa") reasons.push("conforto para primeira tatuagem");
  if (tags.presence==="impactante") reasons.push("garante presen√ßa visual");
  if (tags.work==="formal") reasons.push("permite maior discri√ß√£o no trabalho");

  return {primary, alts, reasons};
}

// ===== Compositor de texto =====
function composeThemeText(tags){
  const parts = [];
  if (tags.tribute === "pet") {
    parts.push("Retrato realista em preto & branco do seu pet");
  } else if (tags.tribute === "pessoa") {
    parts.push("Retrato realista PB de pessoa querida");
  } else if (tags.tribute === "fe") {
    parts.push("S√≠mbolo de f√©/prote√ß√£o em realismo PB");
  } else {
    const personaTxt = KB.persona[tags.persona] || "tom pessoal";
    parts.push(`Composi√ß√£o realista PB com ${personaTxt}`);
  }
  if (tags.motive) parts.push(`para ${KB.motive[tags.motive]||"expressar sua ideia"}`);
  if (tags.astro && KB.astro[tags.astro]) parts.push(`acabamento com ${KB.astro[tags.astro].resumo}`);
  if (tags.values && KB.values[tags.values]) {
    const v = KB.values[tags.values];
    parts.push(`e ${v.texto} (${v.toque})`);
  }
  if (tags.music === "rap") parts.push("toque urbano sutil");
  else if (tags.music === "rock") parts.push("texturas mais cruas");
  else if (tags.music === "mpb") parts.push("poesia org√¢nica");

  const frase = parts.filter(Boolean)
    .map((s,i)=> i===0 ? s[0].toUpperCase()+s.slice(1) : s)
    .join(", ").replace(/, ([^,]+)$/, " e $1") + ".";

  const alts = [];
  if (tags.tribute === "pet") {
    alts.push("Close PB do olhar do pet com linhas de vento");
    alts.push("Silhueta do pet integrada a geometria minimalista");
    alts.push("Nome/data do pet em realismo suave");
  } else if (tags.tribute === "pessoa") {
    alts.push("Close PB com foco em luz & sombra");
    alts.push("Silhueta com geometria discreta");
    alts.push("Inicial/data como assinatura afetiva");
  } else {
    alts.push("Estudo de luz & sombra com foco no motivo central");
    alts.push("Composi√ß√£o com geometria discreta como moldura");
    alts.push("√çcone afetivo em realismo PB minimalista");
  }
  return { frase, alts: alts.slice(0,3) };
}

// ===== SERIALIZA√á√ÉO / ENVIOS =====
function serializeAnswersForSubmit(Q, answers) {
  const out = {};
  Q.forEach(q=>{
    const v = answers[q.id];
    if(!v) return;
    if(q.type === "text"){
      out[q.id] = v.value || "";
    } else if(q.type === "single"){
      out[q.id] = v.label || "";
      out[q.id+"_tags"] = v.tags || {};
    } else if(q.type === "multi"){
      const arr = Array.isArray(v) ? v : [];
      out[q.id] = arr.map(o=>o.label).join("; ");
      out[q.id+"_tags"] = arr.map(o=>o.tags||{});
    }
  });
  return out;
}
function flattenAllForFormspree(REC, RAW){
  const flat = {
    theme: (REC.themes && REC.themes[0]) || "",
    alt_themes: (REC.themes || []).slice(1,4).join(" | "),
    placement: REC.placement || "",
    placement_alt1: REC.placementAlts && REC.placementAlts[0] || "",
    placement_alt2: REC.placementAlts && REC.placementAlts[1] || "",
    sizeLabel: REC.sizeLabel || "",
    sizeCm: REC.sizeCm || "",
    persona: REC.persona || "",
    hoursEstimate: REC.hours || "",
    priceEstimate: REC.priceEstimate || "",
    tema_principal: REC.temaPrincipal || "",
    alternativas_txt: (REC.alternativasTxt || [])
      ? (Array.isArray(REC.alternativasTxt) ? REC.alternativasTxt.join(" | ") : String(REC.alternativasTxt))
      : ""
  };
  Object.keys(RAW||{}).forEach(k=>{
    if(!k.endsWith("_tags")) flat["q_"+k] = RAW[k];
  });
  Object.entries(RAW||{}).forEach(([k,v])=>{
    if(!k.endsWith("_tags")) return;
    if(Array.isArray(v)){
      const codes = [];
      v.forEach(obj=>{
        Object.entries(obj||{}).forEach(([kk,vv])=>{
          if(kk==="area"){ codes.push(String(vv)); }
        });
      });
      if(codes.length){
        flat["tag_areas"] = codes.join(" | ");
        const ALL = ["braco","perna","costas","peito","costela","mao","pescoco","nenhuma"];
        ALL.forEach(a=>{ flat["area_"+a] = codes.includes(a) ? 1 : ""; });
      }
    }else if(v && typeof v==="object"){
      Object.entries(v).forEach(([kk,vv])=>{
        flat["tag_"+kk] = vv;
      });
    }
  });
  const rt = REC.tags || {};
  ["motive","universe","vis","work","pain","session","day","period","budgetMin","budgetMax","tribute","presence","astro","values","music","first","volu","prefStyle"]
    .forEach(k=>{
      if(flat["tag_"+k]==null && rt[k]!=null) flat["tag_"+k]=rt[k];
    });
  return flat;
}
function sendPayload(data){
  const endpoint = FORMSPREE_ENDPOINT;
  if(!endpoint) return;
  const flat = flattenAllForFormspree(data.resumo || {}, data.respostas || {});
  fetch(endpoint,{
    method:"POST",
    headers:{"Content-Type":"application/json","Accept":"application/json"},
    body:JSON.stringify({
      ts:new Date().toISOString(),
      ...data,
      ...flat,
      utm_source: UTM.source,
      utm_medium: UTM.medium,
      utm_campaign: UTM.campaign
    })
  }).catch(()=>{});
}

// ===== UI STATE =====
const app=document.getElementById("app");
let step=0;
const answers={};
const total=Q.length;
let finished=false;

// ===== L√ìGICA PRINCIPAL =====
function recommend(ans){
  const tags={};
  Object.values(ans).forEach(v=>{
    if(!v) return;
    if(Array.isArray(v)) v.forEach(o=>Object.assign(tags,o.tags||{}));
    else Object.assign(tags, v.tags||{});
  });

  const persona=tags.persona||"artistico";
  const universe=tags.universe;

  let themes=[...(THEME_BY_PERSONA[persona]||THEME_BY_PERSONA.artistico)];
  if(universe && CULTURE_MOD[universe]) themes=themes.concat(CULTURE_MOD[universe]);
  if(tags.tribute==="pessoa") themes.unshift("retrato de pessoa querida");
  if(tags.tribute==="pet")    themes.unshift("retrato do seu pet");
  if(tags.tribute==="fe")     themes.unshift("s√≠mbolo de f√©/prote√ß√£o");

  // locais (base)
  let visKey=tags.vis||"media";
  let basePlacements=[...(PLACEMENTS[visKey]||PLACEMENTS.media)];
  if(tags.first) basePlacements=["antebra√ßo interno","panturrilha","ombro",...basePlacements];
  if(tags.volu==="alta") basePlacements=[...LESS_SEEN,...basePlacements];
  if(tags.work==="formal" && visKey!=="baixa") basePlacements=[...LESS_SEEN,...PLACEMENTS.baixa];
  if(tags.pain==="baixa") basePlacements=[...basePlacements.filter(p=>LOW_PAIN.some(lp=>p.includes(lp))),...basePlacements];

  const picked = pickPlacement(basePlacements, tags, ans);

  // tamanho/or√ßamento
  const inv=ans["investimento"]?.tags || {budgetMin:600,budgetMax:1200};
  let hours=hoursFromBudget(inv.budgetMin,inv.budgetMax);
  const multi=ans["tempoSessao"]?.tags?.session==="multi" || inv.budgetMin>=2500;
  let size=sizeFromTime(hours,multi);

  // cap suave para 1¬™ tattoo
  if (tags.first && size.size==="grande"){
    const wantsImpact = tags.presence==="impactante";
    const longSession = ans["tempoSessao"]?.label?.includes("5‚Äì6h") || ans["tempoSessao"]?.tags?.session==="longa" || ans["tempoSessao"]?.tags?.session==="multi";
    if (!(wantsImpact && longSession)) {
      size = {size:"medio", label:"M√©dio"};
      const MAX_H_MEDIO = 4;
      if (hours > MAX_H_MEDIO) hours = MAX_H_MEDIO;
    }
  }

  const cm = SIZE_CM[size.size];
  const priceEstimate = Math.round(hours * HOURLY);

  // justificativa
  const just = [];
  const reasons = picked.reasons || [];
  if (reasons.length) just.push(...reasons);
  if(tags.pain==="baixa") just.push("buscamos regi√£o de menor sensibilidade");
  if(tags.work==="formal") just.push("considera discri√ß√£o no trabalho");
  if(tags.volu==="alta")  just.push("evita ficar no campo de vis√£o constante");
  const justification = `${just.length? just.join(" ¬∑ "):"equil√≠brio entre conforto e est√©tica"} ‚Äî tamanho aproximado ${cm} (${size.label}).`;

  const inspiration = buildInspiration(tags);

  return {
    persona,
    themes:[...new Set(themes)].slice(0,4),
    placementsAll: [picked.primary, ...picked.alts],
    placement: picked.primary || "antebra√ßo interno",
    placementPrimary: picked.primary || "antebra√ßo interno",
    placementAlts: picked.alts || [],
    sizeLabel:size.label,
    sizeCm:cm,
    hours,
    priceEstimate,
    justification,
    inspiration,
    tone:tone(persona),
    tags,
    budget: {min: inv.budgetMin, max: inv.budgetMax}
  };
}

// HTML da p√°gina de resultado (sem <script> dentro)
function buildResultHTML(nome, temaPrincipal, alternativasTema, r, tamanhoLinha){
  const altLocais = (r.placementAlts||[]).join(" ¬∑ ");
  return `<!doctype html><html lang="pt-br"><head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Sugest√£o personalizada</title>
<style>
  :root{--bg:#f7f7f8;--card:#fff;--ink:#111;--muted:#666;--line:#e6e6e8;--radius:16px;--accent:#7A8B55;--accent-ink:#fff}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,sans-serif}
  .wrap{max-width:860px;margin:0 auto;padding:24px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:0 6px 16px rgba(0,0,0,.04);padding:20px}
  .title{font-size:22px;margin:0 0 10px}
  .kicker{font-size:12px;text-transform:uppercase;color:var(--muted);margin-top:14px}
  .row{display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:720px){.row2{grid-template-columns:1fr 1fr}}
  .btn{appearance:none;border:1px solid var(--accent);background:var(--accent);color:var(--accent-ink);border-radius:12px;padding:12px 14px;text-align:center;cursor:pointer}
  .btn:focus-visible{outline:2px solid var(--accent);outline-offset:2px}
  input[type="text"]{width:100%;padding:12px;border:1px solid #d9d9df;border-radius:12px}
  .muted{color:#666}
</style>
</head><body>
<div class="wrap">
  <div class="card">
    <div class="title">${nome}, sua sugest√£o personalizada üé®</div>

    <div class="kicker">Tema recomendado</div>
    <div style="font-size:18px;margin-top:4px">${temaPrincipal}</div>
    <div class="muted" style="margin-top:4px">Alternativas: ${alternativasTema.join(" ¬∑ ")}</div>

    <div class="kicker">Local ideal</div>
    <div style="font-size:18px;margin-top:4px">${r.placementPrimary}</div>
    ${altLocais ? `<div class="muted" style="margin-top:4px">Alternativas de local: ${altLocais}</div>` : ""}

    <div class="kicker">Tamanho e estimativa</div>
    <div style="font-size:16px;margin-top:4px">${tamanhoLinha}</div>

    <div class="kicker">Justificativa</div>
    <div class="muted" style="margin-top:6px">${r.justification}</div>

    ${r.inspiration ? `
      <div class="kicker">Inspira√ß√£o adicional</div>
      <div style="font-size:16px;margin-top:4px">${r.inspiration}</div>` : ""}

    <div class="row row2" style="margin-top:14px">
      <a class="btn" href="https://wa.me/5534999199962" target="_blank" rel="noreferrer noopener">Quero conversar sobre minha ideia no WhatsApp</a>
      <button class="btn" id="copy">Copiar sugest√£o</button>
    </div>

    <div class="card" style="margin-top:14px;border-color:#efefef">
      <div><strong>Quer receber inspira√ß√µes de desenhos</strong>? Deixe seu WhatsApp ou e-mail.
        <em>√â s√≥ para inspirar, sem compromisso.</em></div>
      <div class="row" style="margin-top:8px">
        <input id="lead" type="text" placeholder="(DDD) WhatsApp ou e-mail"/>
        <button class="btn" id="send">Quero receber inspira√ß√µes</button>
      </div>
      <div class="muted" style="margin-top:6px">Sem spam. S√≥ inspira√ß√µes √∫teis.</div>
    </div>
  </div>
</div>
</body></html>`;
}

function finishOnce(){
  if(finished) return;
  finished = true;

  const r = recommend(answers);
  const nome = (answers.nome?.value||"Voc√™");

  const wording = composeThemeText(r.tags);
  const temaPrincipal = wording.frase;
  const alternativasTema = wording.alts;

  const RAW_OBJ = serializeAnswersForSubmit(Q, answers);
  const REC_OBJ = {
    themes: r.themes,
    placement: r.placementPrimary,
    placementAlts: r.placementAlts,
    sizeLabel: r.sizeLabel,
    sizeCm: r.sizeCm,
    hours: r.hours,
    priceEstimate: r.priceEstimate,
    justification: r.justification,
    inspiration: r.inspiration,
    persona: r.persona,
    tags: r.tags,
    temaPrincipal,
    alternativasTxt: alternativasTema
  };

  // envio autom√°tico + dedupe
  const autoKey = makeKey("auto", {REC_OBJ, RAW_OBJ});
  if (!lsGet(autoKey)) {
    sendPayload({
      source:"auto-finish",
      nome: (answers.nome?.value||""),
      contato: null,
      resumo: REC_OBJ,
      respostas: RAW_OBJ,
      ua: navigator.userAgent
    });
    lsSet(autoKey,"1");
  }

  const tamanhoLinha = `${r.sizeLabel} ‚Äî ${r.sizeCm} ‚Äî estimado R$ ${r.priceEstimate.toLocaleString("pt-BR")} (~${r.hours}h)`;
  const txtResumo = `${nome} ‚Äî Tema: ${temaPrincipal} | Local: ${r.placementPrimary}${r.placementAlts[0]?(" ("+r.placementAlts[0]+")"):""} | Tamanho: ${r.sizeLabel} (${r.sizeCm}) | Estimado: R$ ${r.priceEstimate.toLocaleString("pt-BR")}`;

  const html = buildResultHTML(nome, temaPrincipal, alternativasTema, r, tamanhoLinha);
  const w = window.open("", "_blank");
  if (!(w && w.document)) return;
  w.document.open(); w.document.write(html); w.document.close();

  // Handlers na janela de resultado
  const btnCopy = w.document.getElementById("copy");
  if (btnCopy) {
    btnCopy.addEventListener("click", ()=>{
      (w.navigator.clipboard || navigator.clipboard)
        .writeText(txtResumo)
        .then(()=>w.alert("Sugest√£o copiada!"))
        .catch(()=>w.alert("Copie manualmente: "+txtResumo));
    });
  }
  const btnSend = w.document.getElementById("send");
  if (btnSend) {
    let sending = false, sent = false;
    btnSend.addEventListener("click", async ()=>{
      if (sending || sent) return;
      const input = w.document.getElementById("lead");
      const contato = (input?.value||'').trim();
      if(!contato){ w.alert("Preencha seu WhatsApp ou e-mail."); return; }

      const leadKey = makeKey("lead", {contato, REC_OBJ, RAW_OBJ});
      if (lsGet(leadKey)) { w.alert("Esse contato j√° foi registrado para esta sugest√£o. Obrigado! üíö"); return; }

      const oldTxt = btnSend.textContent;
      sending = true; btnSend.disabled = true; btnSend.textContent = "Enviando...";

      try{
        await w.fetch(FORMSPREE_ENDPOINT,{
          method:"POST",
          headers:{"Content-Type":"application/json","Accept":"application/json"},
          body:JSON.stringify({
            ts: new Date().toISOString(),
            source: "lead",
            contato,
            resumo: REC_OBJ,
            respostas: RAW_OBJ,
            ua: navigator.userAgent,
            tema_principal: REC_OBJ.temaPrincipal || "",
            alternativas_txt: Array.isArray(REC_OBJ.alternativasTxt)? REC_OBJ.alternativasTxt.join(" | ") : (REC_OBJ.alternativasTxt || ""),
            placement: REC_OBJ.placement,
            placement_alt1: (REC_OBJ.placementAlts && REC_OBJ.placementAlts[0]) || "",
            placement_alt2: (REC_OBJ.placementAlts && REC_OBJ.placementAlts[1]) || "",
            sizeLabel: REC_OBJ.sizeLabel,
            sizeCm: REC_OBJ.sizeCm,
            hoursEstimate: REC_OBJ.hours,
            priceEstimate: REC_OBJ.priceEstimate,
            utm_source: UTM.source,
            utm_medium: UTM.medium,
            utm_campaign: UTM.campaign
          })
        });
        lsSet(leadKey,"1"); sent = true; btnSend.textContent = "Enviado ‚úÖ";
        if (input) input.value=""; w.alert("Contato registrado! Voc√™ receber√° inspira√ß√µes ‚ú®");
      }catch(e){
        btnSend.disabled = false; btnSend.textContent = oldTxt; sending = false;
        w.alert("N√£o foi poss√≠vel enviar agora. Tente novamente.");
      }
    });
  }
}

// ===== RENDER =====
function render(){
  app.innerHTML="";
  const q=Q[step];

  const prog = el("div", { class: "prog" },
    el("i", { style: `width:${Math.round(((step+1)/total)*100)}%` })
  );

  const card=el("div",{class:"card"},
    el("div",{class:"title"}, q.t),
    q.helper?el("div",{class:"muted"}, q.helper):null,
  );

  if(q.type==="text"){
    const input=el("input",{type:"text",placeholder:q.ph||"",value:answers[q.id]?.value||""});
    input.addEventListener("input", ()=> answers[q.id]={value:input.value,tags:{}});
    const actions=el("div",{class:"actions"},
      el("button",{class:"btn",onClick:()=>{step=Math.max(0,step-1);render();}}, "Voltar"),
      el("button",{class:"btn primary",onClick:()=>{
        if(q.req && !input.value.trim()){ alert("Digite seu nome"); return; }
        if(input.value.trim()) answers[q.id]={value:input.value.trim(),tags:{}};
        if(step === total-1){ finishOnce(); return; }
        step=Math.min(total-1,step+1); render();
      }},"Avan√ßar"),
    );
    card.append(el("div",{class:"row"},input), actions);

  } else if(q.type==="single"){
    const selected = answers[q.id]?.__chosen ?? null;
    const list=el("div",{class:"row row2"});
    q.options.forEach((opt,idx)=>{
      const isSel = selected===idx;
      list.appendChild(
        el("button",{
          class:"btn"+(isSel?" sel":""),
          "aria-pressed": String(!!isSel),
          onClick:()=>{ answers[q.id]={...opt,__chosen:idx}; render(); }
        }, opt.label)
      );
    });
    const canNext = answers[q.id] && answers[q.id].__chosen != null;
    const actions=el("div",{class:"actions"},
      el("button",{class:"btn",onClick:()=>{step=Math.max(0,step-1);render();}}, "Voltar"),
      el("button",{class:"btn primary",disabled:!canNext,onClick:()=>{
        if(!canNext) return;
        if(step === total-1){ finishOnce(); return; }
        step=Math.min(total-1,step+1);
        render();
      }}, "Avan√ßar")
    );
    card.append(list, actions);

  } else if(q.type==="multi"){
    const current = Array.isArray(answers[q.id])?answers[q.id]:[];
    const list=el("div",{class:"row row2"});
    q.options.forEach(opt=>{
      const sel = current.find(o=>o.label===opt.label);
      const isSel = !!sel;
      list.appendChild(el("button",{
        class:"btn"+(isSel?" sel":""),
        "aria-pressed": String(isSel),
        onClick:()=>{
          const arr=Array.isArray(answers[q.id])?[...answers[q.id]]:[];
          const i=arr.findIndex(o=>o.label===opt.label);
          if(i>=0) arr.splice(i,1); else arr.push(opt);
          answers[q.id]=arr; render();
        }}, opt.label));
    });
    const actions=el("div",{class:"actions"},
      el("button",{class:"btn",onClick:()=>{step=Math.max(0,step-1);render();}}, "Voltar"),
      el("button",{class:"btn primary",onClick:()=>{
        if(step === total-1){ finishOnce(); return; }
        step=Math.min(total-1,step+1); render();
      }}, "Avan√ßar"),
    );
    card.append(list,actions);
  }

  app.append(prog,card);
}

// ===== START =====
document.getElementById("year").textContent=new Date().getFullYear();
render();

})();
